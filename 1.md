### **Настройка Удостоверяющего Центра (CA) на базе HashiCorp Vault в Kubernetes с автоматизацией через cert-manager**

Эта инструкция описывает полный цикл развертывания и настройки производственной инфраструктуры открытых ключей (PKI) на базе HashiCorp Vault, работающего в режиме высокой доступности (HA) в кластере Kubernetes. В отличие от двухуровневой схемы, мы будем использовать одноуровневую модель, где Vault сам выступает корневым центром сертификации, что упрощает управление в закрытых средах.

**Ключевые цели и особенности данного руководства:**

1.  **Установка Vault в Kubernetes**: Мы развернем HA-кластер Vault с использованием официального Helm-чарта.
2.  **Одноуровневая PKI**: Мы убираем промежуточный центр сертификации для упрощения. Vault будет напрямую выпускать сертификаты.
3.  **Self-Hosted TLS для Vault**: Vault будет использовать TLS-сертификат, выданный им же, для защиты своего API-трафика внутри кластера.
4.  **Полная автоматизация с cert-manager**: Мы настроим `cert-manager` для автоматического запроса и обновления TLS-сертификатов от Vault для других приложений в кластере.
5.  **Production-Ready**: Все шаги ориентированы на производственное использование, без режима разработки (`dev mode`).

**Предварительные требования:**
*   Рабочий кластер Kubernetes.
*   Установленные и настроенные утилиты `kubectl` и `helm`.
*   Установленный `vault` CLI для взаимодействия с Vault.
*   Установленная утилита `jq` для удобной обработки JSON-вывода.

---

### **Шаг 1: Установка HashiCorp Vault в режиме HA в Kubernetes**

Мы будем использовать Helm для развертывания Vault. Режим HA будет обеспечиваться встроенным хранилищем Raft, что идеально подходит для Kubernetes, так как не требует внешних систем хранения.

1.  **Добавление репозитория HashiCorp:**
    ```bash
    helm repo add hashicorp https://helm.releases.hashicorp.com
    helm repo update
    ```

2.  **Создание файла конфигурации `vault-values.yaml`:**
    Мы создадим файл `vault-values.yaml`, чтобы настроить наш релиз. Изначально мы развернем Vault без TLS, чтобы инициализировать его, а затем добавим TLS-конфигурацию.

    ```yaml
    # vault-values.yaml
    server:
      # Включаем режим высокой доступности (HA)
      ha:
        enabled: true
        replicas: 3
        # Конфигурация встроенного хранилища Raft
        raft:
          enabled: true
          config: |
            ui = true

            storage "raft" {
              path = "/vault/data"
            }

            # На этом этапе мы запускаем listener только на HTTP,
            # чтобы можно было инициализировать и настроить PKI.
            # Позже мы добавим сюда TLS.
            listener "tcp" {
              address = "[::]:8200"
              cluster_address = "[::]:8201"
              tls_disable = "true"
            }

            # Адрес API для внешнего доступа
            api_addr = "http://$(VAULT_ADDR):8200"
            # Адрес для внутрикластерной коммуникации
            cluster_addr = "https://$(HOSTNAME).vault-internal:8201"
    ```

3.  **Установка Vault с помощью Helm:**
    Выполним установку в неймспейс `vault`. Если неймспейса нет, создайте его: `kubectl create namespace vault`.

    ```bash
    helm install vault hashicorp/vault --namespace vault -f vault-values.yaml
    ```
    Дождитесь, пока все поды (`vault-0`, `vault-1`, `vault-2`) перейдут в состояние `Running`.

4.  **Инициализация и распечатывание (Unseal) Vault:**
    Так как мы не используем dev-режим, кластер нужно инициализировать и распечатать.

    ```bash
    # Выполняем команду инициализации на первом поде
    kubectl exec -n vault vault-0 -- vault operator init -key-shares=1 -key-threshold=1 -format=json > vault-keys.json

    # Извлекаем ключ для распечатывания и root-токен.
    # ВНИМАНИЕ: Сохраните эти данные в надежном месте!
    VAULT_UNSEAL_KEY=$(cat vault-keys.json | jq -r ".unseal_keys_b64[0]")
    VAULT_ROOT_TOKEN=$(cat vault-keys.json | jq -r ".root_token")

    echo "Unseal Key: $VAULT_UNSEAL_KEY"
    echo "Root Token: $VAULT_ROOT_TOKEN"

    # Распечатываем каждый под в кластере
    kubectl exec -n vault vault-0 -- vault operator unseal $VAULT_UNSEAL_KEY
    kubectl exec -n vault vault-1 -- vault operator unseal $VAULT_UNSEAL_KEY
    kubectl exec -n vault vault-2 -- vault operator unseal $VAULT_UNSEAL_KEY
    ```

5.  **Настройка подключения к Vault:**
    Для удобства дальнейшей работы настроим переменные окружения и выполним вход.

    ```bash
    # Пробросим порт для локального доступа
    kubectl port-forward -n vault vault-0 8200:8200 &

    # Устанавливаем переменные окружения
    export VAULT_ADDR='http://127.0.0.1:8200'
    export VAULT_TOKEN=$VAULT_ROOT_TOKEN

    # Проверяем статус
    vault status
    ```
    Вы должны увидеть, что кластер HA активен и распечатан.

---

### **Шаг 2: Настройка Корневого Удостоверяющего Центра (CA)**

Теперь, когда Vault работает
